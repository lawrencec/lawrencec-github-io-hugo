<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"><![endif]--><!--[if IE 7]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if IE 8]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class=no-js prefix="og: http://ogp.me/ns#" xmlns:og=http://ogp.me/ns#><!--<![endif]--><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=author content="Lawrence Carvalho"><meta property="og:site_name" content="Just another Nodetraveller"><meta property="og:title" content="Just another Nodetraveller"><meta property="og:url" content="https://blog.nodetraveller.com/post/source/actasundo/"><meta property="og:description" content="Lawrence Carvalho's Personal blog about stuff"><meta property="og:type" content="article"><meta property="og:article:author" content="Lawrence Carvalho"><meta property="og:article:published_time" content="2007-07-18T09:04:36Z"><meta name=generator content="Hugo 0.73.0"><title>ActsAsUndoable &#183; Just another Nodetraveller</title><link rel=canonical href=https://blog.nodetraveller.com/><link rel=alternate type=application/rss+xml title=RSS href><link rel=stylesheet type=text/css href=https://blog.nodetraveller.com/css/main.css><link rel=stylesheet type=text/css href=https://blog.nodetraveller.com/css/syntax.css><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300|Montserrat:700" rel=stylesheet type=text/css><link href=//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css rel=stylesheet></head><body><!--[if lt IE 7]><p class=browsehappy>You are using an <strong>outdated</strong> browser. Please <a href=http://browsehappy.com/>upgrade your browser</a> or <a href=http://www.google.com/chrome/â€Ž>install Google Chrome</a> to experience this site.</p><![endif]--><header id=site-header><div class=container><a href=https://blog.nodetraveller.com/ alt="Just another Nodetraveller"><h1 class="blog-title heading">Just another Nodetraveller</h1></a><p class=blog-description>Lawrence Carvalho's Personal blog about stuff</p></div></header><main class=content role=main><div class=container><article class=post><header class=post-header><h3 class=p-post-title>ActsAsUndoable</h3></header><section class=post-content><p class=f-post-time><time datetime=2007-07-18T09:04:36Z>July 18, 2007</time></p><p>With web apps becoming more and more like Desktop apps, it seems like user interfaces need be more like desktop user interfaces too. Some of these web apps can have a complex UI and their users need to be able to feel comfortable with it. Of course, making the UI as simple as possible is key, but if a task is relatively complex then the UI will also be relatively complex. With more complex tasks, users can make mistakes or want to change things and if they do, they&rsquo;d appreciate a way of doing so. One way to do that is to provide the user a way of undoing their actions; a way to retreat over their history. Just to make clear, this is something along the lines of a user interaction history, not a browser navigation history. Hence ActsAsUndoable, one way of adding undo functionality to your interactive widgets. (Incidentally while I was writing this post, Aza Raskin posted an <a href=http://www.alistapart.com/articles/neveruseawarning>article</a> on <a href=http://www.alistapart.com>A List Apart</a> about using undo functionality in interaction design, which seems to dovetail well with this post.)</p><h2 id=design-patterns>Design Patterns</h2><p>Whenever I code a widget, there&rsquo;s two resources I look to. One is Yahoo!&rsquo;s <a href=http://developer.yahoo.com/ypatterns/>Design Pattern library</a> and the other is Jennifer Tidwell&rsquo;s <a href=http://designinginterfaces.com/>Designing Interfaces</a> book. It&rsquo;s from this book and more specifically the explanation of the <a href=http://designinginterfaces.com/Multi-Level_Undo>Multi-Level Undo pattern</a> that ActsAsUndo is based on.</p><p>Basically the Multi-Level Undo pattern says that if users can navigate through their action history and undo their actions, then they can explore their own work paths quickly and safely. The most obvious desktop example of a navigable history is Photoshop&rsquo;s history panel.</p><p>The pattern states that these kind of actions should be undoable:</p><ul><li><p>Text entry for documents or spreadsheets</p></li><li><p>Database transactions</p></li><li><p>Modifications to images or painting canvases</p></li><li><p>Layout changes &ndash; position, size, stacking order, or grouping in graphic applications</p></li><li><p>File operations, such as deleting or modifying files</p></li><li><p>Creation, deletion or rearrangement of objects such as email messages or spreadsheet columns</p></li><li><p>Any cut, copy, or paste operation</p></li></ul><p>There are apps like these available on the web and some do have some simple undo/history functionality. These do tend to be only a single step undo and then, only for actions that change and save a new state eg move to trash. But also other actions that users make but perhaps don&rsquo;t yet want (or need) to save should also be undoable and at a multiple level too. So, how do we as implement something like the Multi Level Undo <strong>interaction pattern</strong>? We use the <a href=http://en.wikipedia.org/wiki/Memento_pattern>Memento</a> <strong>software design pattern</strong>.</p><h2 id=demos>Demos</h2><p>Two of Jennifer&rsquo;s examples are text entry and stacking order changes. I thought these would be relatively simple examples to use for demo purposes. Here&rsquo;s the <a href=/sandbox/actsasundoable/memento.html>text entry</a> demo and also the <a href=/sandbox/actsasundoable/undo-list.html>stacking order</a> demo. I used the demo of the YUI&rsquo;s sortable list which I hope they don&rsquo;t mind. If you want, take a look at these to see whats going on before reading on.</p><h2 id=text-entry>Text entry</h2><p>The first example I&rsquo;ll cover is the text entry one. It&rsquo;s a simple example of a textarea in which users can enter text and save snaphots. The original class has two properties <strong>el</strong> and <strong>sValue</strong>. <strong>el</strong> represents the textarea and <strong>sValue</strong>, the textarea&rsquo;s value. It has a method called <strong>setText()</strong> whichs sets <strong>sValue</strong> to the value of the textarea.</p><p>Finally we have a <strong>snapshotText()</strong> method which calls <strong>setText()</strong>. We wire a button element to this method.</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=ln> 1</span><span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>UI</span><span class=p>.</span><span class=nx>TextUpdate</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>elId</span><span class=p>,</span><span class=nx>sGroup</span><span class=p>,</span><span class=nx>sPreviewId</span><span class=p>)</span> <span class=p>{</span> 
<span class=ln> 2</span>  <span class=k>this</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=nx>elId</span><span class=p>);</span> 
<span class=ln> 3</span>  <span class=k>this</span><span class=p>.</span><span class=nx>sValue</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>value</span><span class=p>;</span> 
<span class=ln> 4</span><span class=p>}</span> 
<span class=ln> 5</span><span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>UI</span><span class=p>.</span><span class=nx>TextUpdate</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>setText</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>sValue</span><span class=p>)</span> <span class=p>{</span> 
<span class=ln> 6</span>  <span class=k>this</span><span class=p>.</span><span class=nx>sValue</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>sValue</span><span class=p>;</span> 
<span class=ln> 7</span><span class=p>}</span> 
<span class=ln> 8</span><span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>UI</span><span class=p>.</span><span class=nx>TextUpdate</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>snapshotText</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span> 
<span class=ln> 9</span>  <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>sValue</span> <span class=o>!=</span> <span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
<span class=ln>10</span>    <span class=k>this</span><span class=p>.</span><span class=nx>setText</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>value</span><span class=p>);</span> 
<span class=ln>11</span>  <span class=p>}</span> 
<span class=ln>12</span><span class=p>}</span>
</code></pre></div><p>We can add undoable functionality by augmenting it with <strong>YAHOO.Acts.as.Undoable</strong>. This adds a <strong>sCaretakerGroup</strong> property and <strong>undo()</strong>,<strong>redo()</strong>,<strong>revert()</strong> and <strong>restore()</strong> methods. All we need to do is subscribe to the &lsquo;stateLoaded&rsquo; event and make a call to <strong>saveState()</strong> of the Caretaker to record the initial state. We can do this in the constructor of out TextUpdate object or a <strong>init()</strong> method if we choose to use one.</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=ln>1</span><span class=k>this</span><span class=p>.</span><span class=nx>sCareTakerGroup</span> <span class=o>=</span> <span class=nx>sGroup</span><span class=p>;</span> 
<span class=ln>2</span><span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>CaretakerRegistry</span><span class=p>.</span><span class=nx>subscribe</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>sCareTakerGroup</span><span class=p>,</span><span class=s1>&#39;stateLoaded&#39;</span><span class=p>,</span><span class=k>this</span><span class=p>.</span><span class=nx>restore</span><span class=p>,</span><span class=k>this</span><span class=p>,</span><span class=kc>true</span><span class=p>);</span>
<span class=ln>3</span><span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>CaretakerRegistry</span><span class=p>.</span><span class=nx>saveState</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>sCareTakerGroup</span><span class=p>,</span><span class=s1>&#39;New&#39;</span><span class=p>,{</span><span class=s1>&#39;args&#39;</span><span class=o>:</span><span class=p>[</span><span class=k>this</span><span class=p>.</span><span class=nx>sValue</span><span class=p>],</span><span class=s1>&#39;execute&#39;</span><span class=o>:</span><span class=k>this</span><span class=p>.</span><span class=nx>setText</span><span class=p>,</span><span class=s1>&#39;oScope&#39;</span><span class=o>:</span><span class=k>this</span><span class=p>});</span>
</code></pre></div><p>The first line just sets up a property that allows us to identify a caretaker to manage our states (more on this later).</p><p>The second line subscribes to an event called &lsquo;stateLoaded&rsquo; and sets the callback to our <strong>restore()</strong> method.</p><p>Then, the third line saves our initial state. We need to do this so the <strong>revert()</strong> method can revert to the initial state. The callback we specify here depends on your object</p><p>So now our TextUpdate class looks like this :</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=ln> 1</span><span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>UI</span><span class=p>.</span><span class=nx>TextUpdate</span>  <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>elId</span><span class=p>,</span><span class=nx>sGroup</span><span class=p>,</span><span class=nx>sPreviewId</span><span class=p>)</span> <span class=p>{</span> 
<span class=ln> 2</span>  <span class=k>this</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=nx>elId</span><span class=p>);</span> 
<span class=ln> 3</span>  <span class=k>this</span><span class=p>.</span><span class=nx>sValue</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>value</span><span class=p>;</span> 
<span class=ln> 4</span>
<span class=ln> 5</span>  <span class=c1>//Interact with caretaker 
</span><span class=ln> 6</span><span class=c1></span>  <span class=k>this</span><span class=p>.</span><span class=nx>sCareTakerGroup</span> <span class=o>=</span> <span class=nx>sGroup</span><span class=p>;</span> 
<span class=ln> 7</span>  <span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>CaretakerRegistry</span><span class=p>.</span><span class=nx>subscribe</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>sCareTakerGroup</span><span class=p>,</span><span class=s1>&#39;stateLoaded&#39;</span><span class=p>,</span><span class=k>this</span><span class=p>.</span><span class=nx>restore</span><span class=p>,</span><span class=k>this</span><span class=p>,</span><span class=kc>true</span><span class=p>);</span>
<span class=ln> 8</span>  <span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>CaretakerRegistry</span><span class=p>.</span><span class=nx>saveState</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>sCareTakerGroup</span><span class=p>,</span><span class=s1>&#39;New&#39;</span><span class=p>,{</span><span class=s1>&#39;args&#39;</span><span class=o>:</span><span class=p>[</span><span class=k>this</span><span class=p>.</span><span class=nx>sValue</span><span class=p>],</span><span class=s1>&#39;execute&#39;</span><span class=o>:</span><span class=k>this</span><span class=p>.</span><span class=nx>setText</span><span class=p>,</span><span class=s1>&#39;oScope&#39;</span><span class=o>:</span><span class=k>this</span><span class=p>});</span> 
<span class=ln> 9</span><span class=p>}</span>
<span class=ln>10</span>
<span class=ln>11</span><span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>UI</span><span class=p>.</span><span class=nx>TextUpdate</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>setText</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>sValue</span><span class=p>)</span> <span class=p>{</span> 
<span class=ln>12</span>  <span class=k>this</span><span class=p>.</span><span class=nx>sValue</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>sValue</span><span class=p>;</span> 
<span class=ln>13</span><span class=p>}</span> 
<span class=ln>14</span>
<span class=ln>15</span><span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>UI</span><span class=p>.</span><span class=nx>TextUpdate</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>snapshotText</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span> 
<span class=ln>16</span>  <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>sValue</span> <span class=o>!=</span> <span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span> 
<span class=ln>17</span>     <span class=k>this</span><span class=p>.</span><span class=nx>setText</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>value</span><span class=p>);</span> 
<span class=ln>18</span>    <span class=c1>//saves value to caretaker 
</span><span class=ln>19</span><span class=c1></span>    <span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>CaretakerRegistry</span><span class=p>.</span><span class=nx>saveState</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>sCareTakerGroup</span><span class=p>,</span><span class=kc>null</span><span class=p>,{</span><span class=s1>&#39;args&#39;</span><span class=o>:</span><span class=p>[</span><span class=k>this</span><span class=p>.</span><span class=nx>sValue</span><span class=p>],</span><span class=s1>&#39;execute&#39;</span><span class=o>:</span><span class=k>this</span><span class=p>.</span><span class=nx>setText</span><span class=p>,</span><span class=s1>&#39;oScope&#39;</span><span class=o>:</span><span class=k>this</span><span class=p>});</span> 
<span class=ln>20</span>  <span class=p>}</span> 
<span class=ln>21</span><span class=p>}</span>
<span class=ln>22</span><span class=c1>//make undoable
</span><span class=ln>23</span><span class=c1></span><span class=nx>YAHOO</span><span class=p>.</span><span class=nx>augment</span><span class=p>(</span><span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>UI</span><span class=p>.</span><span class=nx>TextUpdate</span><span class=p>,</span><span class=nx>YAHOO</span><span class=p>.</span><span class=nx>Acts</span><span class=p>.</span><span class=nx>as</span><span class=p>.</span><span class=nx>Undoable</span><span class=p>);</span>
</code></pre></div><p>The last line adds the undoable functionality to the TextUpdate object. (see next code snippet)</p><p>But what&rsquo;s all this caretaker stuff? Well, the Memento software design pattern is an established pattern that helps to implement undo functionality. I touched on the Memento pattern in an <a href=/Flash/design-patterns-in-flash.html>earlier post</a> about object-oriented Actionscript.</p><p>The Memento pattern has three classes; Originator, Caretaker and Memento. Basically using these three classes, the Memento pattern works likes this:</p><p>If an Originator wants its state or some of its state to be undoable or redoable, then it must save its state to a Caretaker. This Caretaker will manage the various states (Mementos) of our Originator. (isn&rsquo;t it lovely terminology?)</p><p>Using this as a premise, we can devise a simple &lsquo;framework&rsquo; for adding multi level undo functionality to our apps. We don&rsquo;t need (or want) to create lots of class hierarchy for our apps but the only classes we need to create revolve around the Caretaker object. Each object that we need undo functionality for, we have a corresponding caretaker. To manage multiple Caretaker objects (since perhaps multiple objects need a separate history), we use a CaretakerRegistry singleton object to do so. This allows Caretaker objects to be registered and created, if not done so already. It also acts as proxy to caretaker objects as all calls to Caretakers are made via the CaretakerRegistry. A registry also allows multiple objects to monitor state changes of an Originator. See the HistoryList section for an example of such an object</p><p>Interaction is achieved using CustomEvents. Caretaker objects fire &lsquo;stateLoaded&rsquo; and &lsquo;stateSaved&rsquo; events. Originator objects subscribe to the &lsquo;stateLoaded event. Any other object that is interested in the state of our Originator will subscribe to both &lsquo;stateLoaded&rsquo; and &lsquo;stateSaved&rsquo; events. Each event passes the Memento object to each listening object.</p><p>Everytime the state of our object has changed and needs to be saved, we call the <strong>saveState</strong> method (see line 19) of our object&rsquo;s Caretaker which makes a note of the new state and fires off a &lsquo;stateSaved&rsquo; event.</p><p>Here are the methods that ActsAsUndoable adds.</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=ln> 1</span><span class=cm>/**
</span><span class=ln> 2</span><span class=cm> * redo changes
</span><span class=ln> 3</span><span class=cm> */</span>
<span class=ln> 4</span> <span class=nx>undo</span> <span class=o>:</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
<span class=ln> 5</span>	<span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>CaretakerRegistry</span><span class=p>.</span><span class=nx>loadState</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>sCareTakerGroup</span><span class=p>);</span>
<span class=ln> 6</span> <span class=p>},</span>
<span class=ln> 7</span>
<span class=ln> 8</span><span class=cm>/**
</span><span class=ln> 9</span><span class=cm> * Redo changes
</span><span class=ln>10</span><span class=cm> */</span>
<span class=ln>11</span> <span class=nx>redo</span> <span class=o>:</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
<span class=ln>12</span>	<span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>CaretakerRegistry</span><span class=p>.</span><span class=nx>loadState</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>sCareTakerGroup</span><span class=p>,</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
<span class=ln>13</span> <span class=p>},</span>
<span class=ln>14</span>	
<span class=ln>15</span><span class=cm>/**
</span><span class=ln>16</span><span class=cm> * Revert to initial text value
</span><span class=ln>17</span><span class=cm> * 
</span><span class=ln>18</span><span class=cm> */</span>
<span class=ln>19</span><span class=nx>revert</span> <span class=o>:</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
<span class=ln>20</span>	<span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>CaretakerRegistry</span><span class=p>.</span><span class=nx>loadState</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>sCareTakerGroup</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
<span class=ln>21</span><span class=p>},</span>
<span class=ln>22</span>	
<span class=ln>23</span><span class=cm>/**
</span><span class=ln>24</span><span class=cm> * 
</span><span class=ln>25</span><span class=cm> * 
</span><span class=ln>26</span><span class=cm> * @param {Object} oState Object containing callback to call with specified 
</span><span class=ln>27</span><span class=cm> * arguments and scope. Fields are :
</span><span class=ln>28</span><span class=cm> * 
</span><span class=ln>29</span><span class=cm> * {Array} 	oState.args Array of arguments to call callback with
</span><span class=ln>30</span><span class=cm> * {fn}  		oState.execute Calblack function
</span><span class=ln>31</span><span class=cm> * {Object}	oState.oScope Object to use as scope for callback
</span><span class=ln>32</span><span class=cm> */</span>
<span class=ln>33</span><span class=nx>restore</span> <span class=o>:</span> <span class=kd>function</span><span class=p>(</span><span class=nx>oState</span><span class=p>)</span> <span class=p>{</span>
<span class=ln>34</span>  <span class=k>if</span> <span class=p>(</span><span class=nx>oState</span><span class=p>.</span><span class=nx>execute</span><span class=p>)</span> <span class=p>{</span>
<span class=ln>35</span>	<span class=nx>oState</span><span class=p>.</span><span class=nx>execute</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>oState</span><span class=p>.</span><span class=nx>oScope</span><span class=p>,</span><span class=nx>oState</span><span class=p>.</span><span class=nx>args</span><span class=p>);</span>	
<span class=ln>36</span>  <span class=p>}</span>
<span class=ln>37</span><span class=p>}</span>
</code></pre></div><p>Our object also has <strong>undo()</strong>,<strong>redo()</strong>,<strong>revert()</strong> methods, all of which call the <strong>loadState()</strong> method of the Caretaker. This, in turn, fires off a &lsquo;stateLoaded&rsquo; event. Because our originating object subscribes to the &lsquo;stateLoaded&rsquo; event it is passed the Memento object, which represents the state of the object that it needs to be undone, redone or reverted to. The listening method of our object that the custom event fires to is called <strong>restore()</strong>. This is the method that sets the state of our object. The <strong>restore()</strong> method is passed an object with three properties. These are <strong>args</strong>,<strong>execute</strong>, and <strong>oScope</strong> and are defined when we save the state via the <strong>saveState()</strong> method. Our <strong>restore()</strong> simply calls the method specified in <strong>execute</strong> passing as args those specified in <strong>args</strong> using <strong>oScope</strong> as the scope for the method.. I restore the state of the object like this (via a method call) rather than simply overwriting some properties with older properties as often some logic needs to be run as well; just resetting the properties probably won&rsquo;t suffice in anything other than a very simple widget). The best way to do that is via existing methods on our originating object. For the pattern heads out there, this way is similar to the <a href=http://en.wikipedia.org/wiki/Command_pattern>command pattern</a> without actually creating Command objects - the existing methods are the Commands.</p><h2 id=stacking-order>Stacking Order</h2><p>The <a href=/sandbox/actsasundoable/undo-list.html>stacking order demo</a> is similar. I rewrote the example to reflect the changes needed to make the reordering done by single method (orderLi). Also I haven&rsquo;t augmented it with ActsAsUndoable as I don&rsquo;t use the undo, redo or revert functionality in the UI. The source for YAHOO.example.DDApp is probably a good example to view if you want to see how to add undoable functionality without using augmentation.</p><h2 id=history-list>History List</h2><p>The History List object is one that listens to state changes of a given object and renders them in a list. It shows how other objects besides the Originator can monitor changes of state. Clicking on each item in the list, rolls back the state of that object to the state. You just initialise it with the id of the container and the CaretakerGroup that the object you&rsquo;re providing a history for is using.</p><p>Each link in the history list is a named anchor. However in the update() method, we stop the Event so the browser doesn&rsquo;t actually add it to its own history. We don&rsquo;t want the act of navigating through the history of our own actions within our task to interfere with the history of our browser.</p><p>We can create a new HistoryList object that monitors changes to our object by this :</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=ln>1</span><span class=nx>hl</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>YAHOO</span><span class=p>.</span><span class=nx>NT</span><span class=p>.</span><span class=nx>UI</span><span class=p>.</span><span class=nx>HistoryList</span><span class=p>(</span><span class=s1>&#39;hlistCont&#39;</span><span class=p>,</span><span class=s1>&#39;textArea&#39;</span><span class=p>);</span> 
</code></pre></div><p>The first is the id of an element in which to render the history list. The second is the name of the caretaker group to monitor. The list is rendered to the document and any saves, reverts, undo etc are shown in this list.</p><h2 id=resources-and-notes->Resources and notes :</h2><ul><li><p>The ActsAsUndoable was an interim tongue-in-cheek working name but I kinda like it. The Acts.as namespace is a bit overkill but it fits pretty well and will work out nicely in future things I want to post about.</p></li><li><p>Accessibility - we should set the tabindex of our textarea or list to -1 and focus() them when a history list item is clicked or pressed. See this <a href=http://juicystudio.com/article/making-ajax-work-with-screen-readers.php>making ajax work with screen readers article</a> from <a href=http://juicystudio.com/>Juicystudio</a></p></li><li></li><li><p>For the textUpdate example I&rsquo;ve used the word &lsquo;snapshot&rsquo; rather than &lsquo;save&rsquo; as &lsquo;save&rsquo; would probably mean save permanently to most people. Another button called save could easily be added that would do a true save via normal form functionality. It could even be done using AJAX and the <a href=http://developer.yahoo.com/yui/history/>Browser History manager</a> from the YUI library, which would add an item to the history list. Having said that, we don&rsquo;t want to confuse user with two histories; browser history and what I call User Interaction History.</p></li><li><p>I used the terms as specified as in the Memento Design Pattern. These aren&rsquo;t the clearest names and I was in two minds of calling Caretaker and CaretakerRegistry, UserActionManager and UserActionManagerRegistry. But I suppose these objects can be used for things other than user actions so I kept the design pattern language.</p></li></ul><p>You can download the <a href=http://www.nodetraveller.com/downloads/ActsAsUndoable.zip>examples and js files.</a> One of these days I&rsquo;ll make my subversion repo public but for now old fashioned zip files will have to do.</p><p>Finally, thanks to Tony Kabalan for being a sound board and inputting some useful ideas.</p></section><hr><footer class=post-footer><section class=f-1><section class=author><p>Words by Lawrence Carvalho</p></section></section><section class=f-2><section class=f-post-tags><span><i class="fa fa-tag"></i></span><ul class=post-tags><li><a href=/tags/actsasundo>Actsasundo</a></li><li><a href=/tags/javascript>Javascript</a></li><li><a href=/tags/memento>Memento</a></li><li><a href=/tags/ui>U i</a></li><li><a href=/tags/undo>Undo</a></li><li><a href=/tags/undoable>Undoable</a></li></ul></section><section class=share><span>Share:
<a class=icon-twitter href="http://twitter.com/share?text=ActsAsUndoable&url=https%3a%2f%2fblog.nodetraveller.com%2fpost%2fsource%2factasundo%2f" onclick="window.open(this.href,'twitter-share','width=550,height=235');return false;"><i class="fa fa-twitter"></i></a><a class=icon-facebook href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.nodetraveller.com%2fpost%2fsource%2factasundo%2f" onclick="window.open(this.href,'facebook-share','width=580,height=296');return false;"><i class="fa fa-facebook"></i></a><a class=icon-google-plus href="https://plus.google.com/share?url=https%3a%2f%2fblog.nodetraveller.com%2fpost%2fsource%2factasundo%2f" onclick="window.open(this.href,'google-plus-share','width=490,height=530');return false;"><i class="fa fa-google-plus"></i></a></span></section></section></footer></article></div></main><footer id=site-footer><div class=container><a href=https://www.github.com/lawrencec title=GitHub target=_blank><span class=tooltip><i class="fa fa-github"></i></span></a><a href=https://blog.nodetraveller.com/index.xml title="Get the RSS feed"><span class=tooltip><i class="fa fa-rss"></i></span></a><section>&copy; <a href=https://blog.nodetraveller.com/>Lawrence Carvalho</a> Copyright 2007-2020 Lawrence Carvalho. All rights reserved.</section><section>Theme by <a href=http://www.jrdnbwmn.com>Jordan Bowman</a>. Generated with <a href=http://gohugo.io/>Hugo</a>.</section></div></footer></body></html>