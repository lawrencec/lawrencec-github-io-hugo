<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"><![endif]--><!--[if IE 7]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if IE 8]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class=no-js prefix="og: http://ogp.me/ns#" xmlns:og=http://ogp.me/ns#><!--<![endif]--><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=author content="Lawrence Carvalho"><meta property="og:site_name" content="Just another Nodetraveller"><meta property="og:title" content="Just another Nodetraveller"><meta property="og:url" content="https://blog.nodetraveller.com/post/source/creating-js-files-with-rhino-from-json/"><meta property="og:description" content="Lawrence Carvalho's Personal blog about stuff"><meta property="og:type" content="article"><meta property="og:article:author" content="Lawrence Carvalho"><meta property="og:article:published_time" content="2007-11-13T23:41:59Z"><meta name=generator content="Hugo 0.73.0"><title>Creating js files with Rhino (from JSON) &#183; Just another Nodetraveller</title><link rel=canonical href=https://blog.nodetraveller.com/><link rel=alternate type=application/rss+xml title=RSS href><link rel=stylesheet type=text/css href=https://blog.nodetraveller.com/css/main.css><link rel=stylesheet type=text/css href=https://blog.nodetraveller.com/css/syntax.css><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300|Montserrat:700" rel=stylesheet type=text/css><link href=//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css rel=stylesheet></head><body><!--[if lt IE 7]><p class=browsehappy>You are using an <strong>outdated</strong> browser. Please <a href=http://browsehappy.com/>upgrade your browser</a> or <a href=http://www.google.com/chrome/â€Ž>install Google Chrome</a> to experience this site.</p><![endif]--><header id=site-header><div class=container><a href=https://blog.nodetraveller.com/ alt="Just another Nodetraveller"><h1 class="blog-title heading">Just another Nodetraveller</h1></a><p class=blog-description>Lawrence Carvalho's Personal blog about stuff</p></div></header><main class=content role=main><div class=container><article class=post><header class=post-header><h3 class=p-post-title>Creating js files with Rhino (from JSON)</h3></header><section class=post-content><p class=f-post-time><time datetime=2007-11-13T23:41:59Z>November 13, 2007</time></p><p>(This is primarily a note to myself)</p><p>I&rsquo;ve been playing with Rhino. Specifically, reading in json objects, turning that into normal, runnable objects and saving that to a file so browsers can run it. More specifically, the code that transforms the JSON to an object in the browser should be exactly the same as the one that runs in Rhino. That way I don&rsquo;t have to maintain two different versions.</p><p>I&rsquo;m working on an idea that requires reading in JSON objects and creating objects with methods and properties based on that JSON and could be normally done per request of the page. Obviously, if the JSON is pretty much static, it would be best if we could save the resulting object to a file and reference that file in our pages instead. It would save 1) the request for the JSON file and 2) processing to create the final object. There are two steps to do this.</p><ol><li><p>Transform the JSON</p></li><li><p>Saving the object</p></li></ol><h2 id=transform-the-json>Transform the JSON</h2><p>Easy, enough. Iterate through the JSON object, create new object and add methods and properties to it as you see fit. To save it though you need a String representation of the object. Gecko&rsquo;s toSource() method helps there.</p><h2 id=saving-the-object>Saving the object</h2><p>In Rhino, make use of Java&rsquo;s FileWriter object and save it to the filesystem. If your object is really simple then that&rsquo;s probably it and you&rsquo;ll be able to run the object in your browser. If your final object makes use of closures then you&rsquo;ll get errors, obviously, as the variables the closures have reference to, aren&rsquo;t being created at all when the code is run in the browser. Solution (when run in Rhino) is to turn those methods that use closures into strings and add the variables in via regexp or whatever and then eval it!! Remember, it&rsquo;s only done in Rhino, so it&rsquo;s only done once. One thing to note, you don&rsquo;t have to replace every occurence of that variable name, only the first one (or add a initialisation statement for that variable to the function). Now when the code is written out to file (and read back in by the browser) the variables will have a valid value.</p><p>For simple types, like String or numbers, this will work fine. For objects or arrays, you could use toSource() but that just dumps out a object literal of the object at that time and not a reference which is what you really need. The other thing is you&rsquo;ll have a large object dump in the final code which makes the final code much much larger than you need. The solution then is store these objects in an Array or manager object (outside this system) and retrieve them as needed within your final code.</p><p>Here&rsquo;s an example:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=ln> 1</span><span class=p>.</span>
<span class=ln> 2</span><span class=p>.</span>
<span class=ln> 3</span><span class=nx>o</span><span class=p>[</span><span class=nx>sMethodName</span><span class=p>]</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>varA</span><span class=p>,</span><span class=nx>varB</span><span class=p>){</span>
<span class=ln> 4</span><span class=kd>var</span> <span class=nx>f</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>var1</span><span class=p>){</span>
<span class=ln> 5</span><span class=c1>//Use of an objManager to retrieve object we need
</span><span class=ln> 6</span><span class=c1>//varA and varB have no value in Rhino
</span><span class=ln> 7</span><span class=c1></span><span class=nx>objManager</span><span class=p>.</span><span class=nx>getObj</span><span class=p>(</span><span class=nx>var1</span><span class=p>).</span><span class=nx>method</span><span class=p>(</span><span class=nx>varA</span><span class=p>,</span><span class=nx>varB</span><span class=p>);</span>
<span class=ln> 8</span><span class=p>};</span>
<span class=ln> 9</span><span class=c1>//so for rhino
</span><span class=ln>10</span><span class=c1></span><span class=k>if</span> <span class=p>((</span><span class=k>typeof</span> <span class=k>this</span><span class=p>[</span><span class=s2>&#34;load&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;function&#34;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=k>typeof</span> <span class=k>this</span><span class=p>[</span><span class=s2>&#34;Packages&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;function&#34;</span><span class=p>))</span> <span class=p>{</span>
<span class=ln>11</span><span class=c1>//so get string version of function
</span><span class=ln>12</span><span class=c1></span><span class=kd>var</span> <span class=nx>fString</span> <span class=o>=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>toString</span><span class=p>();</span>
<span class=ln>13</span><span class=c1>//replace variable names with actual variable value.          
</span><span class=ln>14</span><span class=c1></span><span class=nx>fString</span> <span class=o>=</span> <span class=nx>fString</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=s1>&#39;varA&#39;</span><span class=p>,</span> <span class=s1>&#39;&#34;&#39;</span> <span class=o>+</span> <span class=nx>varA</span> <span class=o>+</span> <span class=s1>&#39;&#34;&#39;</span><span class=p>);</span>
<span class=ln>15</span><span class=nx>fString</span> <span class=o>=</span> <span class=nx>fString</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=s1>&#39;varB&#39;</span><span class=p>,</span> <span class=s1>&#39;&#34;&#39;</span> <span class=o>+</span> <span class=nx>varB</span> <span class=o>+</span> <span class=s1>&#39;&#34;&#39;</span><span class=p>);</span>
<span class=ln>16</span><span class=k>return</span> <span class=nb>eval</span><span class=p>(</span><span class=nx>fString</span><span class=p>);</span>
<span class=ln>17</span><span class=p>}</span>
<span class=ln>18</span> 
<span class=ln>19</span><span class=k>return</span> <span class=nx>f</span><span class=p>;</span>
<span class=ln>20</span> 
<span class=ln>21</span><span class=p>}(</span><span class=nx>a</span><span class=p>,</span><span class=nx>b</span><span class=p>);</span>
<span class=ln>22</span><span class=p>.</span>
<span class=ln>23</span><span class=p>.</span>
<span class=ln>24</span><span class=p>.</span>
</code></pre></div><p>There you go. Ugly, more than probably not robust but it&rsquo;s the only way I&rsquo;ve found to do what I need to do for my use case; admittedly probably not a common usage scenario.</p><p>Is there a better way?</p></section><hr><footer class=post-footer><section class=f-1><section class=author><p>Words by Lawrence Carvalho</p></section></section><section class=f-2><section class=f-post-tags><span><i class="fa fa-tag"></i></span><ul class=post-tags><li><a href=/tags/Javascript>Javascript</a></li><li><a href=/tags/json>Json</a></li><li><a href=/tags/rhino>Rhino</a></li></ul></section><section class=share><span>Share:
<a class=icon-twitter href="http://twitter.com/share?text=Creating%20js%20files%20with%20Rhino%20%28from%20JSON%29&url=https%3a%2f%2fblog.nodetraveller.com%2fpost%2fsource%2fcreating-js-files-with-rhino-from-json%2f" onclick="window.open(this.href,'twitter-share','width=550,height=235');return false;"><i class="fa fa-twitter"></i></a><a class=icon-facebook href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.nodetraveller.com%2fpost%2fsource%2fcreating-js-files-with-rhino-from-json%2f" onclick="window.open(this.href,'facebook-share','width=580,height=296');return false;"><i class="fa fa-facebook"></i></a><a class=icon-google-plus href="https://plus.google.com/share?url=https%3a%2f%2fblog.nodetraveller.com%2fpost%2fsource%2fcreating-js-files-with-rhino-from-json%2f" onclick="window.open(this.href,'google-plus-share','width=490,height=530');return false;"><i class="fa fa-google-plus"></i></a></span></section></section></footer></article></div></main><footer id=site-footer><div class=container><a href=https://www.github.com/lawrencec title=GitHub target=_blank><span class=tooltip><i class="fa fa-github"></i></span></a><a href=https://blog.nodetraveller.com/index.xml title="Get the RSS feed"><span class=tooltip><i class="fa fa-rss"></i></span></a><section>Copyright 2007-2020 Lawrence Carvalho. All rights reserved.</section><section>Theme by <a href=http://www.jrdnbwmn.com>Jordan Bowman</a>. Generated with <a href=http://gohugo.io/>Hugo</a>.</section></div></footer></body></html>